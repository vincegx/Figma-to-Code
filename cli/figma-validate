#!/bin/bash

# figma-validate - Validation visuelle Claude + corrections (~500 tokens)
# Usage: ./figma-validate node-9-2654-1730728354

set -e

# Colors
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check arguments
if [ -z "$1" ]; then
  echo -e "${RED}‚ùå Test ID manquant${NC}"
  echo ""
  echo "Usage: ./figma-validate <test-id>"
  echo ""
  echo "Exemple:"
  echo "  ./figma-validate node-9-2654-1730728354"
  echo ""
  echo "Liste des tests disponibles:"
  ls -1 src/generated/export_figma/ 2>/dev/null | grep "^node-" | head -5
  exit 1
fi

TEST_ID="$1"
TEST_DIR="src/generated/export_figma/$TEST_ID"

# Check test directory exists
if [ ! -d "$TEST_DIR" ]; then
  echo -e "${RED}‚ùå Test non trouv√©: $TEST_DIR${NC}"
  echo ""
  echo "Tests disponibles:"
  ls -1 src/generated/export_figma/ 2>/dev/null | grep "^node-" | head -10
  exit 1
fi

# Check required files exist
REQUIRED_FILES=(
  "$TEST_DIR/Component-fixed.tsx"
  "$TEST_DIR/img/figma-screenshot.png"
  "$TEST_DIR/web-render.png"
)

for file in "${REQUIRED_FILES[@]}"; do
  if [ ! -f "$file" ]; then
    echo -e "${RED}‚ùå Fichier manquant: $file${NC}"
    echo ""
    echo "Le test semble incomplet. Avez-vous lanc√© figma-analyze?"
    exit 1
  fi
done

# Display info
echo -e "${GREEN}üîç Validation Claude pour: $TEST_ID${NC}"
echo ""
echo "Test directory: $TEST_DIR"
echo ""
echo "Fichiers √† comparer:"
echo "  - img/figma-screenshot.png (design Figma r√©f√©rence)"
echo "  - web-render.png (rendu web actuel)"
echo ""
echo "Workflow:"
echo "  1. Copie Component-fixed.tsx ‚Üí Component-final.tsx"
echo "  2. Claude compare images et corrige Component-final.tsx"
echo "  3. Recapture web-render-final.png"
echo "  4. Claude re-v√©rifie (max 2 it√©rations)"
echo "  5. G√©n√©ration validation-report.md"
echo ""
echo -e "${YELLOW}‚ö†Ô∏è  Consommation estim√©e: ~300-600 tokens (validation it√©rative)${NC}"
echo ""
read -p "Continuer? [y/N] " -n 1 -r
echo ""

if [[ ! $REPLY =~ ^[Yy]$ ]]; then
  echo "Annul√©."
  exit 0
fi

# Pre-processing: Copy Component-fixed.tsx to Component-final.tsx
echo ""
echo -e "${YELLOW}üìã Pr√©paration...${NC}"
if [ -f "$TEST_DIR/Component-fixed.tsx" ]; then
  cp "$TEST_DIR/Component-fixed.tsx" "$TEST_DIR/Component-final.tsx"
  echo -e "${GREEN}‚úì${NC} Component-final.tsx cr√©√© (copie de Component-fixed.tsx)"
else
  echo -e "${RED}‚ùå Component-fixed.tsx non trouv√©${NC}"
  exit 1
fi

# Launch Claude Code with prompt
echo ""
echo -e "${GREEN}üöÄ Lancement de Claude Code...${NC}"
echo ""

# Check if claude command exists
if ! command -v claude &> /dev/null; then
  echo -e "${RED}‚ùå Commande 'claude' non trouv√©e${NC}"
  echo ""
  echo "Installez Claude CLI: https://docs.anthropic.com/claude/docs"
  exit 1
fi

# Iterative validation loop (max 2 iterations)
MAX_ITERATIONS=2
ALL_CORRECTIONS=""
WEB_SCREENSHOT="$TEST_DIR/web-render.png"

for iteration in $(seq 1 $MAX_ITERATIONS); do
  echo ""
  echo -e "${YELLOW}‚îÅ‚îÅ‚îÅ It√©ration $iteration/$MAX_ITERATIONS ‚îÅ‚îÅ‚îÅ${NC}"
  echo ""

  # Debug: show what we're about to run
  WEB_SCREENSHOT_NAME=$(basename "$WEB_SCREENSHOT")
  echo -e "${YELLOW}[DEBUG]${NC} Test: $TEST_ID"
  echo -e "${YELLOW}[DEBUG]${NC} Screenshot: $WEB_SCREENSHOT_NAME"
  echo ""

  # Run Claude Code with custom prompt (substitute variables and pipe)
  echo -e "${GREEN}Ex√©cution de Claude Code...${NC}"
  PROMPT=$(cat cli/prompts/validate-minimal.md | sed "s/{{test_id}}/$TEST_ID/g" | sed "s/{{web_screenshot}}/$WEB_SCREENSHOT_NAME/g")
  CLAUDE_OUTPUT=$(echo "$PROMPT" | claude -p 2>&1)
  exit_code=$?

  echo "$CLAUDE_OUTPUT"

  if [ $exit_code -ne 0 ]; then
    echo ""
    echo -e "${RED}‚ùå Erreur lors de la validation (code: $exit_code)${NC}"
    exit $exit_code
  fi

  # Extract corrections from Claude output
  CORRECTIONS=$(echo "$CLAUDE_OUTPUT" | sed -n '/VALIDATION_CORRECTIONS_START/,/VALIDATION_CORRECTIONS_END/p' | grep -v "VALIDATION_CORRECTIONS")

  # Append to all corrections
  if [ -n "$ALL_CORRECTIONS" ]; then
    ALL_CORRECTIONS="${ALL_CORRECTIONS}\n\n### It√©ration $iteration:\n$CORRECTIONS"
  else
    ALL_CORRECTIONS="### It√©ration $iteration:\n$CORRECTIONS"
  fi

  # Check if corrections are needed
  if echo "$CORRECTIONS" | grep -q "Aucune correction"; then
    echo ""
    echo -e "${GREEN}‚úÖ Fid√©lit√© 100% atteinte - Arr√™t des it√©rations${NC}"
    break
  fi

  # Recapture screenshot with Component-final.tsx
  echo ""
  echo -e "${YELLOW}üì∏ Recapture du screenshot...${NC}"

  # Check if running in Docker
  if [ -f /.dockerenv ]; then
    # Inside Docker
    node scripts/post-processing/capture-screenshot.js "$TEST_DIR" 5173 > /dev/null 2>&1
  else
    # Outside Docker
    docker exec mcp-figma-v1 node scripts/post-processing/capture-screenshot.js "$TEST_DIR" 5173 > /dev/null 2>&1
  fi

  if [ $? -eq 0 ]; then
    # Rename to web-render-final.png for next iteration
    mv "$TEST_DIR/web-render.png" "$TEST_DIR/web-render-final.png"
    WEB_SCREENSHOT="$TEST_DIR/web-render-final.png"
    echo -e "${GREEN}‚úì${NC} Screenshot recaptur√©: web-render-final.png"
  else
    echo -e "${RED}‚ö†${NC} Erreur lors de la recapture - continuation avec screenshot actuel"
  fi

  # If last iteration, don't loop
  if [ $iteration -eq $MAX_ITERATIONS ]; then
    echo ""
    echo -e "${YELLOW}‚ö†Ô∏è  Nombre max d'it√©rations atteint${NC}"
  fi
done

# Post-processing: Generate validation-report.md
echo ""
echo -e "${YELLOW}üìù G√©n√©ration du rapport...${NC}"

REPORT_FILE="$TEST_DIR/validation-report.md"
CURRENT_DATE=$(date "+%Y-%m-%d %H:%M:%S")

# Generate report
cat > "$REPORT_FILE" <<EOF
# Rapport de validation - $TEST_ID

**Date:** $CURRENT_DATE

## R√©sum√©

- **Fichier source:** Component-fixed.tsx (pipeline AST)
- **Fichier final:** Component-final.tsx (corrections visuelles valid√©es)
- **R√©f√©rence:** img/figma-screenshot.png
- **Rendu initial:** web-render.png
- **Rendu final:** web-render-final.png
- **It√©rations:** $iteration

## Corrections appliqu√©es

$(echo -e "$ALL_CORRECTIONS")

## R√©sultat

‚úÖ **Fid√©lit√© visuelle : 100%**

---

_G√©n√©r√© automatiquement par figma-validate_
EOF

echo -e "${GREEN}‚úì${NC} validation-report.md g√©n√©r√©"
echo ""
echo -e "${GREEN}üéâ Fichiers g√©n√©r√©s:${NC}"
echo "  - $TEST_DIR/Component-final.tsx"
echo "  - $TEST_DIR/web-render-final.png"
echo "  - $TEST_DIR/validation-report.md"
echo ""
echo -e "${GREEN}‚úÖ Validation termin√©e apr√®s $iteration it√©ration(s)${NC}"
