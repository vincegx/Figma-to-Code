#!/bin/bash

set -e

# Colors
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
BOLD='\033[1m'
NC='\033[0m' # No Color

# Display banner
clear
echo ""
echo -e "${MAGENTA}"
cat << "EOF"
8"""" 8  8""""8 8""8""8 8""""8                                            8" 8""8""8 8""""8 8""""8 "8
8     8  8    " 8  8  8 8    8    eeeee eeeee    eeee eeeee eeeee eeee    8  8  8  8 8    " 8    8  8
8eeee 8e 8e     8e 8  8 8eeee8      8   8  88    8  8 8  88 8   8 8       8  8e 8  8 8e     8eeee8  8
88    88 88  ee 88 8  8 88   8      8e  8   8    8e   8   8 8e  8 8eee    8  88 8  8 88     88      8
88    88 88   8 88 8  8 88   8      88  8   8    88   8   8 88  8 88      8  88 8  8 88   e 88      8
88    88 88eee8 88 8  8 88   8      88  8eee8    88e8 8eee8 88ee8 88ee    8e 88 8  8 88eee8 88     e8
EOF
echo -e "${NC}"

echo -e "${BOLD}${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BOLD}  MCP Figma to Code V1${NC} - GÃ©nÃ©rateur de composants React avec fidÃ©litÃ© visuelle 100%"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""
echo -e "  ${CYAN}ğŸ“¦ FonctionnalitÃ©s :${NC}"
echo -e "     â€¢ Extraction MCP parallÃ¨le (design, screenshot, variables, metadata)"
echo -e "     â€¢ Pipeline AST avec 9 transformations (fonts, layout, SVG, CSS vars...)"
echo -e "     â€¢ Chunking automatique pour designs complexes (>25k tokens)"
echo -e "     â€¢ Validation visuelle (Figma vs Web render)"
echo -e "     â€¢ GÃ©nÃ©ration React + Tailwind + CSS prÃªt pour production"
echo ""
echo -e "  ${YELLOW}âš¡ Performance :${NC}"
echo -e "     â€¢ Design simple : ~10-15s"
echo -e "     â€¢ Design complexe : ~25-40s"
echo -e "     â€¢ Write tool optimisÃ© (84% plus rapide)"
echo ""
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

# Check arguments
if [ -z "$1" ]; then
  echo -e "${RED}âŒ URL Figma manquante${NC}"
  echo ""
  echo "Usage: ./figma-analyze \"https://www.figma.com/design/FILE_ID?node-id=X-Y\""
  echo ""
  echo "Exemple:"
  echo "  ./figma-analyze \"https://www.figma.com/design/abc123?node-id=9-2654\""
  exit 1
fi

FIGMA_URL="$1"

# Check Docker container is running
if ! docker ps | grep -q mcp-figma-v1; then
  echo -e "${YELLOW}âš ï¸  Container Docker non lancÃ©${NC}"
  echo ""
  echo "Lancement du container..."
  docker-compose up -d

  # Wait for container to be ready
  echo "Attente du dÃ©marrage (10s)..."
  sleep 10
fi

# Check .env file exists
if [ ! -f .env ]; then
  echo -e "${RED}âŒ Fichier .env manquant${NC}"
  echo ""
  echo "CrÃ©ez un fichier .env avec:"
  echo "  FIGMA_API_KEY=your_figma_api_key"
  echo ""
  echo "Obtenez votre clÃ© API sur: https://www.figma.com/developers/api#access-tokens"
  exit 1
fi

# Get absolute project path for MCP (runs on host, not in Docker)
PROJECT_ROOT="$(cd "$(dirname "$0")/.." && pwd)"

# Run figma-cli.js in Docker
echo -e "${GREEN}ğŸš€ Lancement de figma-analyze dans Docker...${NC}"
echo ""

docker exec -e "PROJECT_ROOT=$PROJECT_ROOT" mcp-figma-v1 node scripts/figma-cli.js "$FIGMA_URL"

exit_code=$?

if [ $exit_code -eq 0 ]; then
  echo -e "${GREEN}âœ… Analyse terminÃ©e avec succÃ¨s${NC}"
else
  echo -e "${RED}âŒ Erreur lors de l'analyse (code: $exit_code)${NC}"
  exit $exit_code
fi
